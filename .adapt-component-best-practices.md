# Adapt Framework Component Development - Best Practices Guide

**Version:** 1.0.0  
**Last Updated:** 2025-11-08  
**Framework:** Adapt Framework v5.53.3+  
**Authoring Tool:** v0.11.5+

This guide documents best practices learned from developing the adapt-scrollMarquee component. Use this as a standard for all future Adapt component plugins.

---

## Table of Contents

1. [Project Structure](#project-structure)
2. [Component Architecture](#component-architecture)
3. [Template System](#template-system)
4. [External Libraries (GSAP, etc.)](#external-libraries)
5. [Component Lifecycle](#component-lifecycle)
6. [CSS & Styling](#css--styling)
7. [Accessibility](#accessibility)
8. [Responsive Design](#responsive-design)
9. [Properties Schema](#properties-schema)
10. [Documentation](#documentation)
11. [Git Workflow](#git-workflow)
12. [Testing Checklist](#testing-checklist)

---

## Project Structure

### Required Files

```
adapt-[component-name]/
├── js/
│   ├── adapt-[component-name].js      # Component registration
│   ├── [component-name]View.js        # View logic
│   └── [optional-helpers].js          # Helper modules
├── less/
│   └── [component-name].less          # Styles with CSS variables
├── properties.schema                   # Authoring Tool schema
├── bower.json                         # Bower package config
├── package.json                       # NPM package config
├── example.json                       # Example configuration
├── README.md                          # Main documentation
├── CUSTOMIZATION.md                   # CSS customization guide
├── .adapt-component-guide.md          # Internal dev notes (if needed)
└── LICENSE                            # GPL-3.0 or appropriate
```

### File Naming Conventions

- **Component name**: lowercase with hyphens (e.g., `scroll-marquee`)
- **View files**: camelCase with suffix (e.g., `scrollMarqueeView.js`)
- **CSS classes**: BEM methodology (e.g., `scroll-marquee__item`)

---

## Component Architecture

### Component Registration

**File:** `js/adapt-[component-name].js`

```javascript
import components from 'core/js/components';
import ComponentView from './[component-name]View';
import ComponentModel from 'core/js/models/componentModel';

export default components.register('[componentName]', {
  model: ComponentModel.extend({}),
  view: ComponentView
});
```

### View Structure

**File:** `js/[component-name]View.js`

```javascript
import ComponentView from 'core/js/views/componentView';
import a11y from 'core/js/a11y';

class ComponentNameView extends ComponentView {

  className() {
    return [
      super.className(),
      'component-name'
    ].join(' ');
  }

  render() {
    // Manual rendering preferred for v5.53.3
    const data = this.model.toJSON();
    const html = `
      <div class="component__inner component-name__inner">
        <!-- Your markup -->
      </div>
    `;
    
    this.$el.html(html);
    this.$el.addClass(this.className());
    
    setTimeout(() => {
      if (this.postRender) {
        this.postRender();
      }
    }, 0);
    
    return this;
  }

  preRender() {
    this.listenTo(this.model, 'change:_isComplete', this.onCompleteChange);
  }

  postRender() {
    // CRITICAL: Set ready immediately
    this.setReadyStatus();
    
    // Setup inview completion if needed
    if (this.model.get('_setCompletionOn') === 'inview') {
      this.setupInviewCompletion('.component__widget', this.onInview.bind(this));
    }

    // Load external libraries or setup after
    this.setupComponent();
  }

  onInview() {
    if (this.model.get('_isComplete')) return;
    this.setCompletionStatus();
  }

  onCompleteChange(model, isComplete) {
    if (!isComplete) return;
    a11y.toggleAccessibleEnabled(this.$('.component-name__item'), true);
  }

  remove() {
    // Cleanup event listeners, timers, external libraries
    if (this.scrollHandler) {
      window.removeEventListener('scroll', this.scrollHandler);
    }
    super.remove();
  }
}

export default ComponentNameView;
```

---

## Template System

### Adapt v5.53.3 Recommendations

**⚠️ IMPORTANT:** Adapt v5.53.3 has unreliable JSX/Handlebars support in plugins.

**✅ RECOMMENDED: Manual HTML Rendering**

```javascript
render() {
  const data = this.model.toJSON();
  
  const html = `
    <div class="component__inner">
      <div class="component__widget">
        <div class="component-name__content">
          ${data.body || ''}
        </div>
      </div>
    </div>
  `;
  
  this.$el.html(html);
  this.$el.addClass(this.className());
  
  // Ensure postRender is called
  setTimeout(() => {
    if (this.postRender) {
      this.postRender();
    }
  }, 0);
  
  return this;
}
```

**❌ AVOID:** JSX templates (unless framework version explicitly supports it)
**❌ AVOID:** Handlebars templates in plugins (use for core only)

---

## External Libraries

### Problem: AMD/RequireJS Conflicts

Adapt uses RequireJS (AMD), which intercepts library loads. Libraries like GSAP, Three.js, etc. detect AMD and export as modules instead of globals.

### Solution: Loader Pattern

**Create a loader module** (e.g., `js/gsapLoader.js`):

```javascript
class LibraryLoader {
  constructor() {
    this.loaded = false;
    this.loading = false;
    this.loadPromise = null;
  }

  load() {
    if (this.loaded) {
      return Promise.resolve();
    }

    if (this.loading) {
      return this.loadPromise;
    }

    this.loading = true;
    this.loadPromise = this.loadLibrary();
    return this.loadPromise;
  }

  loadLibrary() {
    // Check if already loaded globally
    if (window.LIBRARY) {
      this.loaded = true;
      return Promise.resolve();
    }

    const loadScript = (url, globalName) => {
      return fetch(url)
        .then(response => response.text())
        .then(code => {
          // Save AMD/CommonJS environment
          const savedDefine = window.define;
          const savedExports = window.exports;
          const savedModule = window.module;
          
          try {
            // Disable module loaders
            window.define = undefined;
            window.exports = undefined;
            window.module = undefined;
            
            // Execute code - library attaches to window
            eval(code);
          } finally {
            // Restore environment
            if (savedDefine) window.define = savedDefine;
            if (savedExports) window.exports = savedExports;
            if (savedModule) window.module = savedModule;
          }
        })
        .then(() => this.waitForGlobal(globalName));
    };

    return loadScript('https://cdn.example.com/library.min.js', 'LIBRARY')
      .then(() => {
        this.loaded = true;
        console.log('Library loaded successfully');
      });
  }

  waitForGlobal(globalName, maxAttempts = 50) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      
      const checkGlobal = () => {
        attempts++;
        
        if (window[globalName]) {
          resolve(window[globalName]);
        } else if (attempts >= maxAttempts) {
          reject(new Error(`${globalName} not found after ${maxAttempts} attempts`));
        } else {
          setTimeout(checkGlobal, 100);
        }
      };
      
      checkGlobal();
    });
  }
}

export default new LibraryLoader();
```

### Usage in Component

```javascript
import libraryLoader from './libraryLoader';

postRender() {
  this.setReadyStatus(); // Don't block on library load
  
  // Load library asynchronously
  libraryLoader.load()
    .then(() => {
      this.setupWithLibrary();
    })
    .catch((error) => {
      console.warn('Component: Library failed to load', error);
      // Component still works, just without enhanced features
    });
}
```

---

## Component Lifecycle

### Critical Flow

```
1. constructor()
2. preRender()        - Setup event listeners
3. render()           - Generate HTML
4. postRender()       - CALL setReadyStatus() IMMEDIATELY
5. setupComponent()   - Initialize features
6. onInview()         - Trigger completion
7. remove()           - Cleanup
```

### Key Principles

**✅ DO:**
- Call `setReadyStatus()` immediately in `postRender()`
- Load external libraries asynchronously after `setReadyStatus()`
- Clean up event listeners in `remove()`
- Use `setTimeout(() => this.postRender(), 0)` after `render()`

**❌ DON'T:**
- Block `setReadyStatus()` waiting for async operations
- Forget to call `super.remove()` in cleanup
- Create event listeners without removing them

---

## CSS & Styling

### CSS Custom Properties (Variables)

**✅ ALWAYS USE CSS VARIABLES** for all customizable styles:

```less
.component-name {
  // Define all customizable properties
  --component-font-size: 1.5rem;
  --component-font-weight: 600;
  --component-font-family: inherit;
  --component-text-color: inherit;
  --component-background: transparent;
  --component-padding: 2rem;
  --component-gap: 1rem;
  --component-border-radius: 4px;
  
  &__item {
    font-size: var(--component-font-size);
    font-weight: var(--component-font-weight);
    font-family: var(--component-font-family);
    color: var(--component-text-color);
    background: var(--component-background);
    padding: var(--component-padding);
  }
}
```

### BEM Naming Convention

```less
.component-name {           // Block
  &__element {              // Element
    &--modifier {           // Modifier
    }
  }
}
```

Example:
```less
.scroll-marquee {
  &__widget { }
  &__inner { }
  &__item {
    &--active { }
    &--disabled { }
  }
}
```

### Responsive Design

Use CSS variables for responsive adjustments:

```less
.component-name {
  --component-font-size: 1.5rem;
  
  @media (max-width: 900px) {
    --component-font-size: 1.35rem;
  }
  
  @media (max-width: 520px) {
    --component-font-size: 1.2rem;
  }
}
```

### Absolute Values Only

**❌ DON'T** use theme LESS variables in plugins:
```less
color: @item-text-color;  // DON'T - may not be defined
```

**✅ DO** use absolute values or inherit:
```less
color: #333;              // DO - absolute value
color: inherit;           // DO - inherit from parent
```

---

## Accessibility

### Mandatory Features

#### 1. ARIA Attributes

```html
<div class="component__widget" 
     role="region" 
     aria-label="${ariaLabel}"
     aria-live="polite">
```

#### 2. Reduced Motion Support

```javascript
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

if (prefersReducedMotion) {
  this.$el.addClass('component--reduced-motion');
  // Disable animations
  return;
}
```

```less
// CSS support
@media (prefers-reduced-motion: reduce) {
  .component {
    animation: none !important;
    transform: none !important;
    transition: none !important;
  }
}
```

#### 3. Screen Reader Support

```html
<!-- Hidden text for screen readers -->
<div class="component__sr-only" aria-hidden="false">
  Static content for screen readers
</div>
```

```less
&__sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
```

#### 4. Manual Disable Option

Add to properties.schema:

```json
{
  "_disableAnimation": {
    "type": "boolean",
    "required": false,
    "default": false,
    "title": "Disable Animation",
    "inputType": "Checkbox",
    "help": "Disable animations for accessibility purposes"
  }
}
```

#### 5. Keyboard Navigation

Ensure all interactive elements are keyboard accessible:

```javascript
this.$('.component__button').attr('tabindex', '0');
this.$('.component__button').on('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    this.handleAction();
  }
});
```

### Accessibility Checklist

- [ ] ARIA role and labels
- [ ] `prefers-reduced-motion` support
- [ ] Screen reader only content
- [ ] Manual disable option
- [ ] Keyboard navigation
- [ ] Focus management
- [ ] High contrast mode compatible
- [ ] WCAG 2.1 AA compliant
- [ ] Screen reader tested (JAWS, NVDA, VoiceOver)

---

## Responsive Design

### Device Support

Test on:
- Desktop (Chrome, Firefox, Safari, Edge)
- Mobile (iOS Safari, Android Chrome)
- Tablet (iPad, Android tablets)

### Window Resize Handling

```javascript
const handleResize = () => {
  const newViewportWidth = window.innerWidth;
  const widthDiff = Math.abs(newViewportWidth - this.lastViewportWidth);
  
  // Only recalculate if significant change (>100px)
  if (widthDiff > 100) {
    this.recalculate();
  }
  
  this.lastViewportWidth = newViewportWidth;
};

window.addEventListener('resize', handleResize, { passive: true });
this.resizeHandler = handleResize;
```

### Passive Event Listeners

**✅ ALWAYS** use `{ passive: true }` for scroll and resize:

```javascript
window.addEventListener('scroll', handler, { passive: true });
window.addEventListener('resize', handler, { passive: true });
```

### Cross-Browser Scroll Position

```javascript
const getScrollY = () => 
  window.pageYOffset || 
  window.scrollY || 
  document.documentElement.scrollTop || 
  0;
```

---

## Properties Schema

### Structure

```json
{
  "type": "object",
  "$schema": "http://json-schema.org/draft-04/schema",
  "id": "http://jsonschema.net",
  "$ref": "http://localhost/plugins/content/component/model.schema",
  "globals": {
    "ariaRegion": {
      "type": "string",
      "required": true,
      "default": "Component description for screen readers",
      "inputType": "Text",
      "validators": [],
      "translatable": true
    }
  },
  "properties": {
    "_supportedLayout": {
      "type": "string",
      "required": true,
      "enum": ["full-width", "half-width", "both"],
      "default": "full-width",
      "editorOnly": true
    },
    "_setCompletionOn": {
      "type": "string",
      "required": false,
      "default": "inview",
      "title": "Set completion on:",
      "enum": ["inview", "manual"],
      "inputType": {
        "type": "Select",
        "options": ["inview", "manual"]
      },
      "validators": [],
      "help": "Whether completion is based on viewport visibility"
    }
  }
}
```

### Property Types

| Type | Input | Example |
|------|-------|---------|
| `string` | Text | Title, description |
| `number` | Number | Speed, duration |
| `boolean` | Checkbox | Enable/disable features |
| `array` | List | Multiple items |
| `object` | Nested | Complex data structures |

### Best Practices

- Include helpful `help` text for each property
- Set sensible `default` values
- Use `enum` for fixed options
- Mark fields as `translatable: true` if user-facing text
- Validate with appropriate `validators`

---

## Documentation

### Required Files

#### 1. README.md

Include:
- Component description
- How It Works section
- Attributes documentation
- Dependencies
- Accessibility features
- Browser support
- Tips
- Example usage

#### 2. CUSTOMIZATION.md

Include:
- All CSS variables
- 5-6 complete styling examples
- Advanced customization techniques
- Responsive examples
- Dark mode support
- Where to add custom CSS

#### 3. example.json

Provide a complete working example configuration:

```json
{
  "_id": "c-105",
  "_parentId": "b-55",
  "_type": "component",
  "_component": "componentName",
  "_classes": "",
  "_layout": "full",
  "title": "Component Title",
  "displayTitle": "Display Title",
  "body": "Body text content",
  "_customProperty": 2
}
```

#### 4. Internal Dev Notes (Optional)

Create `.adapt-[feature]-guide.md` for complex technical details:
- GSAP integration notes
- AMD/RequireJS workarounds
- Template system issues
- Debugging tips

---

## Git Workflow

### Version Numbering (Semantic Versioning)

- **Major** (x.0.0): Breaking changes
- **Minor** (0.x.0): New features, backward compatible
- **Patch** (0.0.x): Bug fixes

### Commit Messages

Follow conventional commits:

```
type(scope): description

- Detail 1
- Detail 2
- Detail 3
```

Types:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation
- `style`: Formatting
- `refactor`: Code restructuring
- `test`: Tests
- `chore`: Maintenance

Examples:
```
feat: Add scroll velocity tracking for marquee animation

fix: Resolve ScrollTrigger initialization when component visible on load

docs: Add comprehensive CSS customization guide

chore: Bump version to 3.12.0
```

### Release Process

```bash
# 1. Make changes
git add .
git commit -m "feat: Add new feature"

# 2. Update version in bower.json, package.json
# Edit version numbers

# 3. Commit version bump
git add bower.json package.json
git commit -m "chore: Bump version to x.y.z"

# 4. Push to main
git push origin main

# 5. Create and push tag
git tag -a vx.y.z -m "Version x.y.z - Description"
git push origin vx.y.z
```

---

## Testing Checklist

### Functionality

- [ ] Component renders correctly
- [ ] External libraries load properly
- [ ] Animations work smoothly
- [ ] Interactions respond correctly
- [ ] Completion tracking works
- [ ] Data persists correctly

### Accessibility

- [ ] Screen reader announces content properly
- [ ] Keyboard navigation works
- [ ] Reduced motion respected
- [ ] High contrast mode compatible
- [ ] Focus indicators visible
- [ ] ARIA labels correct

### Responsive

- [ ] Desktop display correct
- [ ] Tablet display correct
- [ ] Mobile display correct
- [ ] Orientation changes handled
- [ ] Window resize works
- [ ] Touch interactions work

### Cross-Browser

- [ ] Chrome (latest)
- [ ] Firefox (latest)
- [ ] Safari (latest)
- [ ] Edge (latest)
- [ ] iOS Safari
- [ ] Android Chrome

### Performance

- [ ] No console errors
- [ ] No memory leaks
- [ ] Smooth scrolling (60fps)
- [ ] Fast initial load
- [ ] Event listeners cleaned up

### Integration

- [ ] Works in Authoring Tool
- [ ] Properties schema correct
- [ ] Installs via bower
- [ ] Compiles successfully
- [ ] Exports correctly
- [ ] Preview works

---

## Common Pitfalls

### ❌ Blocking setReadyStatus()

```javascript
// DON'T
postRender() {
  await this.loadLibrary();  // Blocks parent views
  this.setReadyStatus();
}
```

```javascript
// DO
postRender() {
  this.setReadyStatus();  // Immediate
  this.loadLibrary().then(() => this.setup());
}
```

### ❌ Forgetting Event Cleanup

```javascript
// DON'T
remove() {
  super.remove();
  // Listeners still active!
}
```

```javascript
// DO
remove() {
  if (this.scrollHandler) {
    window.removeEventListener('scroll', this.scrollHandler);
  }
  super.remove();
}
```

### ❌ Using Theme Variables

```less
// DON'T
color: @item-text-color;
```

```less
// DO
color: inherit;
color: #333;
```

### ❌ Not Supporting Reduced Motion

```javascript
// DON'T
setupAnimation() {
  this.animate();  // Always animates
}
```

```javascript
// DO
setupAnimation() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    return;  // Respect user preference
  }
  this.animate();
}
```

---

## Summary

### Golden Rules

1. **✅ Manual HTML rendering** in Adapt v5.53.3
2. **✅ Call setReadyStatus() immediately** in postRender()
3. **✅ Load external libraries asynchronously** after setReadyStatus()
4. **✅ Use CSS variables** for all styling
5. **✅ Support reduced motion** and accessibility
6. **✅ Clean up event listeners** in remove()
7. **✅ Use passive event listeners** for scroll/resize
8. **✅ Test on all devices** and browsers
9. **✅ Document thoroughly** (README + CUSTOMIZATION)
10. **✅ Follow semantic versioning** and conventional commits

### Resources

- **Adapt Framework Wiki**: https://github.com/adaptlearning/adapt_framework/wiki
- **Adapt Authoring Tool**: https://github.com/adaptlearning/adapt_authoring
- **This Component**: https://github.com/fosterc1/adapt-margueetext
- **WCAG Guidelines**: https://www.w3.org/WAI/WCAG21/quickref/

---

**This guide is a living document.** Update it as you learn new best practices and encounter new challenges.

**Version History:**
- v1.0.0 (2025-11-08): Initial creation based on adapt-scrollMarquee development
